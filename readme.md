照度差ステレオの仕組みを体験してみよう！
====

Woodhamによって提案された照度差ステレオのアルゴリズムを体感するツール

## 概要

照度差ステレオとは、3以上の異なる光源方向から物体を照らし、撮影された画像から物体の法線を推定し、3次元形状を復元する手法です。

![図1](readme_pic/photometrtc_pic(1).jpg)

手法の詳しい仕組みなどについては、以下の記事に書いているのでもしよろしければ御覧ください。

このプロジェクトでは、

* 推定に用いる球の画像を生成
* 生成した画像から法線を推定

の2つのプログラムにより、実際に物体の法線推定を行うことで照度差ステレオのアルゴリズムを体感することができます。

## 利用方法

### (1) git clone

まず、以下のコマンドを実行してください。

```
git clone https://github.com/momoyama1192/PracticePhotometric.git
```

言語は、Python3もしくはMATLABに対応しています。

ただし、球の生成をPython3で行い、法線推定をMATLABで行うというような、Python3とMATLABを混合して使うことはできません。


### (2) 事前インストール

※ MATLABの場合、追加プログラムは不要なので、読み飛ばしてもらって構いません。


Python3の場合、`opencv-python` と `numpy` のインストールが必須です。

インストールをしていない場合、以下のコマンドを使うなどして、必ず入れてください。

```
pip install opencv-python
pip install numpy
```

照度差ステレオを体感するだけであればバージョンは特に気にしなくてもOKです。

なお、私は以下のバージョンにて動作確認を行っております。

```
Package        Version
-------        -------
opencv-python  4.4.0.46
numpy          1.18.2
```

### (3) 画像生成

画像生成を行い、法線推定に使うための画像を生成します。

設定できるパラメーターは、以下の通りです。

```
[画像に関する設定]
N_ROW      : 生成する画像の縦方向のピクセル数
N_COL      : 生成する画像の横方向のピクセル数
pic_num    : 生成する画像の数（最低3以上）

[物体に関する設定]
radius     : 生成する球の半径
kyu_x      : 生成する球の中心のx座標
kyu_y      : 生成する球の中心のy座標 
K_d        : 球の拡散反射率 (0以上1以下)

[出力に関する設定 (原則変更の必要なし)]
OUTPUT_DIR : 生成した画像、光源方向を保存するディレクトリ (最後の / は不要)
```

パラメーターを指定後、Pythonであれば `make_input_model.py` を、MATLABであれば `make_input_model.m` を実行してください。

実行を行うと、下のような球の画像が指定された枚数分 `1.pgm`, `2.pgm`, `3.pgm`, … と出力され、さらに光源方向が `light_source.txt` に保存されます。

![図2](readme_pic/photometrtc_pic(10).jpg)

加えて球の真値が記録されたファイルが出力されます。

(Pythonであれば `sn_true.npy`, MATLABであれば `sn_true.mat` で保存されます)

### (4) 法線推定

(3)で生成した画像から球の法線を推定し、以下の3つの方法で結果を出力します。

* 法線マップ（法線の向きを色で可視化した画像）
* 誤差マップ（真値との誤差の度合いを可視化した画像）
* 真値の法線との平均角度誤差（単位はdeg）

設定できるパラメーターは、以下の通りです。

```
[画像に関する設定]
※ この3つのパラメーターは(3)と全く同じにすること！！
N_ROW      : 生成する画像の縦方向のピクセル数
N_COL      : 生成する画像の横方向のピクセル数
pic_num    : 生成する画像の数（最低3以上）


[入力ディレクトリ]
INPUT_DIR : (3)で保存した画像・光源方向があるディレクトリ
(最後の / は不要)

[出力に関する設定 (原則変更の必要なし)]
OUTPUT_DIR : 推定した法線カラーマップ・エラーマップを出力するディレクトリ (最後の / は不要)
```

パラメーターを設定後、Pythonであれば `find_normal2.py` を、MATLABであれば `find_normal2.m` を実行してください。

実行を行うと、真値との誤差がターミナルに表示されます。

さらに、法線マップが `result2.ppm` に、誤差マップが `error2.pgm` に保存されます。

![図2](readme_pic/photometrtc_pic(8).jpg)

### (5) [参考] かげを考慮しない照度差ステレオ

(4)の法線推定では、かげを考慮して法線推定を行っております。

一方、かげを考慮しない場合、考慮した場合に比べて誤差が非常に大きくなってしまいます。

本プロジェクトでは、かげの考慮の有無による法線推定精度の差も体験できるように、かげを考慮しないバージョンの法線推定プログラムも入れています。

<br>

実行方法は、(4)と同じようにパラメーターを設定後、Pythonであれば `find_normal.py` を、MATLABであれば `find_normal.m` を実行してください。

実行を行うと、真値との誤差がターミナルに表示されます。

さらに、法線マップが `result.ppm` に、誤差マップが `error.pgm` に保存されます。

![図2](readme_pic/photometrtc_pic(9).jpg)

## さいごに

このプロジェクトにより、照度差ステレオのアルゴリズムの仕組みなどが体感できれば非常に幸いです。

また、このコードの改良、利用などはご自由にどうぞ。（リンクを貼っていただけたらありがたいです。）

## 参考文献

R. Woodham, “Photometric method for determining surface orientation from multiple images”, Optical Engineering, Vol.19, No.1, pp.139–144, 1980.